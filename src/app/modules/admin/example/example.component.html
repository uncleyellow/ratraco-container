<div class="flex flex-col flex-auto min-w-0 bg-gradient-to-br from-gray-50 to-orange-50">
    <!-- Enhanced Header Section -->
    <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:px-8 border-b bg-white shadow-lg border-gray-200">
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-14 h-14 rounded-xl bg-gradient-to-br from-orange-600 to-orange-700 shadow-lg">
                    <i class="fas fa-train text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight mb-1">
                        Thống kê giờ tàu chạy
                    </h1>
                    <p class="text-base text-gray-600">
                        Quản lý và thống kê dữ liệu vận hành tàu hỏa
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Status Indicator -->
        <div class="flex items-center gap-3 mt-4 sm:mt-0">
            <div class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium shadow-sm transition-all duration-200"
                 [ngClass]="{
                     'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-green-200': canEdit,
                     'bg-gradient-to-r from-amber-500 to-amber-600 text-white shadow-amber-200': !canEdit
                 }">
                <div class="w-3 h-3 rounded-full animate-pulse bg-white"></div>
                <span>{{ canEdit ? 'Có quyền chỉnh sửa' : 'Chỉ đọc' }}</span>
            </div>
            
            <!-- Quick Actions Menu -->
            <div class="relative quick-actions-container">
                <button class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200"
                        (click)="toggleQuickActionsMenu()">
                    <i class="fas fa-ellipsis-v text-gray-600"></i>
                </button>
                
                <!-- Quick Actions Dropdown -->
                <div *ngIf="showQuickActionsMenu" 
                     class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                    <div class="py-1">
                        <button (click)="showDataStatistics()" 
                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 transition-colors duration-200">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Thống kê dữ liệu
                        </button>
                        <button (click)="showAdvancedExportDialog()" 
                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 transition-colors duration-200">
                            <i class="fas fa-file-export mr-2"></i>
                            Xuất nâng cao
                        </button>
                        <div class="border-t border-gray-200 my-1"></div>
                        <button (click)="refreshData()" 
                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 transition-colors duration-200">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Làm mới dữ liệu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-auto p-6 sm:p-8">
        <!-- Enhanced Controls Section -->
        <div class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Table Selection -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-table text-orange-600"></i>
                        Chọn bảng dữ liệu
                    </label>
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-select [(value)]="selectedTable" (selectionChange)="onTableChange($event)"
                                    [disabled]="isLoadingData">
                            <mat-option *ngFor="let table of availableTables" [value]="table.value">
                                <div class="flex items-center gap-3 py-2">
                                    <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                                        <mat-icon class="text-orange-600">{{table.icon}}</mat-icon>
                                    </div>
                                    <span class="font-medium">{{table.label}}</span>
                                </div>
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Search -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-search text-green-600"></i>
                        Tìm kiếm dữ liệu
                    </label>
                    <mat-form-field appearance="outline" class="w-full">
                        <input matInput 
                               placeholder="Nhập từ khóa tìm kiếm..." 
                               [value]="searchValue" 
                               (input)="applyFilter($event)"
                               [disabled]="isLoadingData" />
                        <button *ngIf="searchValue" 
                                matSuffix 
                                mat-icon-button 
                                aria-label="Xóa tìm kiếm" 
                                (click)="clearSearch()"
                                class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-icon matSuffix *ngIf="!searchValue" class="text-gray-400">search</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Data Summary Card -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-info-circle text-purple-600"></i>
                        Tóm tắt dữ liệu
                    </label>
                    <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-database text-orange-500"></i>
                                <span class="text-sm font-medium text-gray-700">{{ dataSource.data.length }} bản ghi</span>
                            </div>
                            <div *ngIf="dataSource.filteredData && dataSource.filteredData.length !== dataSource.data.length" 
                                 class="flex items-center gap-1">
                                <i class="fas fa-filter text-green-500"></i>
                                <span class="text-xs text-green-600 font-medium">{{ dataSource.filteredData.length }} hiển thị</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Action Buttons -->
            <div class="flex flex-wrap gap-4 items-center justify-between bg-white rounded-xl border border-gray-200 p-6 shadow-sm action-buttons-container">
                <div class="flex flex-wrap gap-3">
                    <!-- Export Excel -->
                    <button (click)="exportToExcel()" 
                            [disabled]="isExporting || isLoadingData || dataSource.data.length === 0"
                            class="inline-flex items-center gap-3 px-6 py-3 rounded-lg font-semibold text-white transition-all duration-200 hover:shadow-lg hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                            [ngClass]="{
                                'bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700': !isExporting,
                                'bg-gray-400 cursor-not-allowed': isExporting
                            }">
                        <i class="fas fa-file-excel text-lg" [ngClass]="{'fa-spin': isExporting}"></i>
                        <span>{{ isExporting ? 'Đang xuất...' : 'Xuất Excel' }}</span>
                    </button>

                    <!-- Import Excel -->
                    <label class="inline-flex items-center gap-3 px-6 py-3 rounded-lg font-semibold text-white transition-all duration-200 hover:shadow-lg hover:scale-105 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                           [ngClass]="{
                               'bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700': !isImporting && canEdit,
                               'bg-gray-400 cursor-not-allowed': isImporting || !canEdit
                           }">
                        <i class="fas fa-upload text-lg" [ngClass]="{'fa-spin': isImporting}"></i>
                        <span>{{ isImporting ? 'Đang nhập...' : 'Nhập Excel' }}</span>
                        <input type="file" 
                               accept=".xlsx,.xls" 
                               (change)="onImportExcel($event)" 
                               [disabled]="isImporting || !canEdit"
                               class="hidden" />
                    </label>

                    <!-- Add New Record -->
                    <button (click)="openAddRecordDialog()" 
                            [disabled]="!canEdit || isLoadingData"
                            class="inline-flex items-center gap-3 px-6 py-3 rounded-lg font-semibold text-white bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 transition-all duration-200 hover:shadow-lg hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        <i class="fas fa-plus"></i>
                        <span>Thêm bản ghi</span>
                    </button>
                </div>

                <!-- View Options -->
                <div class="flex items-center gap-3">
                    <button (click)="toggleTableView()" 
                            class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200"
                            [title]="isTableView ? 'Chuyển sang dạng lưới' : 'Chuyển sang dạng bảng'">
                        <i class="fas" [class.fa-th]="!isTableView" [class.fa-list]="isTableView"></i>
                    </button>
                    <button (click)="toggleFullscreen()" 
                            class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200"
                            title="Chế độ toàn màn hình">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Data Table Container -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <!-- Loading Overlay -->
            <div *ngIf="isLoadingData" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                <div class="flex flex-col items-center gap-4">
                    <div class="relative">
                        <mat-spinner diameter="60" class="text-orange-600"></mat-spinner>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-train text-orange-500 text-xl animate-bounce"></i>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-lg font-medium text-gray-900 mb-1">Đang tải dữ liệu...</p>
                        <p class="text-sm text-gray-600">Vui lòng chờ trong giây lát</p>
                    </div>
                </div>
            </div>

            <div class="table-container overflow-x-auto">
                <table mat-table 
                       [dataSource]="dataSource" 
                       matSort 
                       class="w-full modern-table"
                       [class.pointer-events-none]="isLoadingData">
                    
                    <!-- Dynamic Column Definitions -->
                    <ng-container *ngFor="let column of displayedColumns" [matColumnDef]="column">
                        <!-- Enhanced Header Cell -->
                        <th mat-header-cell 
                            *matHeaderCellDef 
                            mat-sort-header
                            class="header-cell bg-gradient-to-r from-orange-700 to-orange-800 text-white font-semibold text-sm uppercase tracking-wide sticky top-0 z-20 border-r border-orange-600"
                            [ngClass]="getColumnClasses(column)">
                            <div class="py-3 px-3 flex items-center justify-center">
                                <div class="text-center">
                                    <span class="leading-tight block text-xs font-medium">
                                        {{ column }}
                                    </span>
                                    <div class="mt-1 text-xs opacity-75">
                                        {{ getColumnTypeLabel(column) }}
                                    </div>
                                </div>
                            </div>
                        </th>
                        
                        <!-- Enhanced Data Cell -->
                        <td mat-cell 
                            *matCellDef="let element; let i = index" 
                            class="cell-content border-b border-gray-100 hover:bg-orange-50 transition-all duration-200 cursor-pointer"
                            [ngClass]="getColumnClasses(column)"
                            [title]="getCellTooltip(element[column], column)"
                            >
                            <div class="py-2 px-2" [ngSwitch]="getColumnType(column)">
                                
                                <!-- Text Input Columns -->
                                <ng-container *ngSwitchCase="'text'">
                                    <div class="input-group relative">
                                        <i class="fas fa-train input-icon text-orange-500 absolute left-2 top-1/2 transform -translate-y-1/2" *ngIf="column === 'Mác tàu'"></i>
                                        <i class="fas fa-file-invoice input-icon text-yellow-600 absolute left-2 top-1/2 transform -translate-y-1/2" *ngIf="column === 'Số xe có vận đơn không phải của RAT'"></i>
                                        <input type="text" 
                                               class="modern-input text-input w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200"
                                               [(ngModel)]="element[column]" 
                                               (change)="updateCellValue(element, column, $event.target.value, i)"
                                               [value]="element[column]" 
                                               [disabled]="!canEdit || isLoadingData"
                                               [placeholder]="getPlaceholder(column)"
                                               [id]="getInputId(column, i)"
                                               (focus)="onInputFocus($event)"
                                               (blur)="onInputBlur($event)"
                                               (keydown)="onKeyDown($event, column, i)">
                                    </div>
                                </ng-container>

                                <!-- DateTime Input Columns -->
                                <ng-container *ngSwitchCase="'datetime'">
                                    <div class="input-group relative">
                                        <i class="fas fa-calendar-alt input-icon absolute left-2 top-1/2 transform -translate-y-1/2" 
                                           [ngClass]="getDateTimeIconClass(column)"></i>
                                        <input type="datetime-local" 
                                               class="modern-input datetime-input w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200"
                                               [(ngModel)]="element[column]" 
                                               (change)="updateCellValue(element, column, $event.target.value, i)"
                                               [value]="element[column]"
                                               [disabled]="!canEdit || isLoadingData"
                                               [id]="getInputId(column, i)"
                                               (focus)="onInputFocus($event)"
                                               (blur)="onInputBlur($event)"
                                               (keydown)="onKeyDown($event, column, i)">
                                    </div>
                                </ng-container>

                                <!-- Number/Text Mixed Columns -->
                                <ng-container *ngSwitchCase="'number-text'">
                                    <div class="input-group relative">
                                        <i class="fas fa-scissors input-icon text-red-500 absolute left-2 top-1/2 transform -translate-y-1/2" *ngIf="column.includes('cắt')"></i>
                                        <i class="fas fa-plus-circle input-icon text-green-500 absolute left-2 top-1/2 transform -translate-y-1/2" *ngIf="column.includes('nối')"></i>
                                        <input type="text" 
                                               class="modern-input number-input w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200"
                                               [(ngModel)]="element[column]" 
                                               (change)="updateCellValue(element, column, $event.target.value, i)"
                                               [value]="element[column]" 
                                               [disabled]="!canEdit || isLoadingData"
                                               [placeholder]="getPlaceholder(column)"
                                               [id]="getInputId(column, i)"
                                               (focus)="onInputFocus($event)"
                                               (blur)="onInputBlur($event)"
                                               (keydown)="onKeyDown($event, column, i)">
                                    </div>
                                </ng-container>

                                <!-- Read-only Columns -->
                                <ng-container *ngSwitchDefault>
                                    <div class="readonly-cell flex items-center justify-center min-h-[40px] p-2">
                                        <!-- Special styling for STT column -->
                                        <span *ngIf="column === 'STT'" 
                                              class="text-orange-600 font-bold text-center break-words text-sm cursor-pointer hover:text-orange-800 transition-colors duration-200 bg-orange-50 px-2 py-1 rounded-full border border-orange-200"
                                              (click)="openDetailDialog(element, i)"
                                              title="Click để xem chi tiết">
                                            #{{ element[column] || '-' }}
                                        </span>
                                        <!-- Other read-only columns -->
                                        <span *ngIf="column !== 'STT'" 
                                              class="text-gray-700 font-medium text-center break-words text-sm cursor-pointer hover:text-orange-600 transition-colors duration-200"
                                              (click)="openDetailDialog(element, i)"
                                              title="Click để xem chi tiết">
                                            {{ element[column] || '-' }}
                                        </span>
                                    </div>
                                </ng-container>
                            </div>
                        </td>
                    </ng-container>
                
                    <!-- Enhanced Table Structure -->
                    <tr mat-header-row *matHeaderRowDef="displayedColumns" class="mat-header-row"></tr>
                    <tr mat-row 
                        *matRowDef="let row; columns: displayedColumns; let i = index" 
                        class="mat-row transition-all duration-200 cursor-pointer hover:bg-orange-50 hover:shadow-sm"
                        [class.bg-gray-50]="i % 2 === 0"
                        [class.bg-white]="i % 2 === 1"
                        (mouseenter)="onRowHover(i, true)"
                        (mouseleave)="onRowHover(i, false)"
                        >
                    </tr>
                </table>
            </div>

            <!-- Enhanced Paginator -->
            <div class="border-t border-gray-200 bg-gradient-to-r from-gray-50 to-orange-50 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Hiển thị {{ (paginator?.pageIndex || 0) * (paginator?.pageSize || 10) + 1 }} - 
                        {{ Math.min((paginator?.pageIndex || 0 + 1) * (paginator?.pageSize || 10), dataSource.data.length) }} 
                        trong tổng số {{ dataSource.data.length }} bản ghi
                    </div>
                    <mat-paginator 
                        [pageSize]="pageSizeOptions[0]"
                        [pageSizeOptions]="pageSizeOptions"
                        [showFirstLastButtons]="true"
                        class="custom-paginator">
                    </mat-paginator>
                </div>
            </div>

            <!-- Enhanced Empty State -->
            <div *ngIf="!isLoadingData && !dataSource.data.length" 
                 class="flex flex-col items-center justify-center p-16 text-gray-500">
                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mb-6 shadow-lg">
                    <i class="fas fa-database text-5xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Không có dữ liệu</h3>
                <p class="text-base text-gray-600 text-center max-w-md mb-6">
                    Hiện tại chưa có dữ liệu nào trong bảng này. Vui lòng thử chọn bảng khác hoặc nhập dữ liệu mới.
                </p>
                <div class="flex gap-3">
                    <button (click)="loadData()" 
                            class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Làm mới
                    </button>
                    <button (click)="openAddRecordDialog()" 
                            [disabled]="!canEdit"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium disabled:opacity-50">
                        <i class="fas fa-plus mr-2"></i>
                        Thêm dữ liệu
                    </button>
                </div>
            </div>

            <!-- Enhanced No Search Results -->
            <div *ngIf="!isLoadingData && dataSource.data.length > 0 && dataSource.filteredData?.length === 0" 
                 class="flex flex-col items-center justify-center p-16 text-gray-500">
                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center mb-6 shadow-lg">
                    <i class="fas fa-search text-5xl text-yellow-500"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Không tìm thấy kết quả</h3>
                <p class="text-base text-gray-600 text-center max-w-md mb-6">
                    Không tìm thấy dữ liệu phù hợp với từ khóa "<strong class="text-orange-600">{{searchValue}}</strong>".
                </p>
                <div class="flex gap-3">
                    <button (click)="clearSearch()" 
                            class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 font-medium">
                        <i class="fas fa-times mr-2"></i>
                        Xóa bộ lọc
                    </button>
                    <button (click)="showSearchTips()" 
                            class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200 font-medium">
                        <i class="fas fa-question-circle mr-2"></i>
                        Mẹo tìm kiếm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

